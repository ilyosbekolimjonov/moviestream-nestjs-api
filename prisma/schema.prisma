generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  // url is configured in prisma.config.ts
}

enum UserRole {
  user
  admin
  superadmin
}

enum SubscriptionStatus {
  active
  expired
  canceled
  pending_payment
}

enum PaymentMethod {
  card
  paypal
  bank_transfer
  crypto
}

enum PaymentStatus {
  pending
  completed
  failed
  refunded
}

enum SubscriptionType {
  free
  premium
}

enum VideoQuality {
  p240
  p360
  p480
  p720
  p1080
  p4K
}

model User {
  id            String   @id @default(uuid())
  username      String   @unique @db.VarChar(50)
  email         String   @unique @db.VarChar(100)
  passwordHash  String   @map("password_hash") @db.VarChar(255)
  role          UserRole @default(user)
  avatarUrl     String?  @map("avatar_url") @db.VarChar(255)
  createdAt     DateTime @default(now()) @map("created_at")

  profile          Profile?
  subscriptions    UserSubscription[]
  createdMovies    Movie[]            @relation("CreatedMovies")
  favorites        Favorite[]
  reviews          Review[]
  watchHistory     WatchHistory[]

  @@map("users")
}

model Profile {
  id        String   @id @default(uuid())
  userId    String   @unique @map("user_id")
  fullName  String?  @map("full_name") @db.VarChar(100)
  phone     String?  @db.VarChar(20)
  country   String?  @db.VarChar(50)
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("profiles")
}

model SubscriptionPlan {
  id           String   @id @default(uuid())
  name         String   @db.VarChar(50)
  price        Decimal  @db.Decimal(10, 2)
  durationDays Int      @map("duration_days")
  features     Json
  isActive     Boolean  @default(true) @map("is_active")

  subscriptions UserSubscription[]

  @@map("subscription_plans")
}

model UserSubscription {
  id         String             @id @default(uuid())
  userId     String             @map("user_id")
  planId     String             @map("plan_id")
  startDate  DateTime           @default(now()) @map("start_date")
  endDate    DateTime?          @map("end_date")
  status     SubscriptionStatus @default(pending_payment)
  autoRenew  Boolean            @default(false) @map("auto_renew")
  createdAt  DateTime           @default(now()) @map("created_at")

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan     SubscriptionPlan @relation(fields: [planId], references: [id])
  payments Payment[]

  @@map("user_subscriptions")
}

model Payment {
  id                    String        @id @default(uuid())
  userSubscriptionId    String        @map("user_subscription_id")
  amount                Decimal       @db.Decimal(10, 2)
  paymentMethod         PaymentMethod @map("payment_method")
  paymentDetails        Json          @map("payment_details")
  status                PaymentStatus
  externalTransactionId String?       @map("external_transaction_id") @db.VarChar(100)
  createdAt             DateTime      @default(now()) @map("created_at")

  subscription UserSubscription @relation(fields: [userSubscriptionId], references: [id], onDelete: Cascade)

  @@map("payments")
}

model Category {
  id          String   @id @default(uuid())
  name        String   @db.VarChar(50)
  slug        String   @unique @db.VarChar(50)
  description String?  @db.Text

  movieCategories MovieCategory[]

  @@map("categories")
}

model Movie {
  id               String           @id @default(uuid())
  title            String           @db.VarChar(100)
  slug             String           @unique @db.VarChar(100)
  description      String?          @db.Text
  releaseYear      Int?             @map("release_year")
  durationMinutes  Int?             @map("duration_minutes")
  posterUrl        String?          @map("poster_url") @db.VarChar(255)
  rating           Decimal?         @db.Decimal(3, 1)
  subscriptionType SubscriptionType @default(free) @map("subscription_type")
  viewCount        Int              @default(0) @map("view_count")
  createdBy        String           @map("created_by")
  createdAt        DateTime         @default(now()) @map("created_at")

  creator         User            @relation("CreatedMovies", fields: [createdBy], references: [id])
  categories      MovieCategory[]
  files           MovieFile[]
  favorites       Favorite[]
  reviews         Review[]
  watchHistory    WatchHistory[]

  @@map("movies")
}

model MovieCategory {
  id         String @id @default(uuid())
  movieId    String @map("movie_id")
  categoryId String @map("category_id")

  movie    Movie    @relation(fields: [movieId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([movieId, categoryId])
  @@map("movie_categories")
}

model MovieFile {
  id       String       @id @default(uuid())
  movieId  String       @map("movie_id")
  fileUrl  String       @map("file_url") @db.VarChar(255)
  quality  VideoQuality
  language String       @default("uz") @db.VarChar(20)

  movie Movie @relation(fields: [movieId], references: [id], onDelete: Cascade)

  @@map("movie_files")
}

model Favorite {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  movieId   String   @map("movie_id")
  createdAt DateTime @default(now()) @map("created_at")

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  movie Movie @relation(fields: [movieId], references: [id], onDelete: Cascade)

  @@unique([userId, movieId])
  @@map("favorites")
}

model Review {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  movieId   String   @map("movie_id")
  rating    Int
  comment   String?  @db.Text
  createdAt DateTime @default(now()) @map("created_at")

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  movie Movie @relation(fields: [movieId], references: [id], onDelete: Cascade)

  @@map("reviews")
}

model WatchHistory {
  id                String   @id @default(uuid())
  userId            String   @map("user_id")
  movieId           String   @map("movie_id")
  watchedDuration   Int      @map("watched_duration")
  watchedPercentage Decimal  @map("watched_percentage") @db.Decimal(5, 2)
  lastWatched       DateTime @default(now()) @map("last_watched")

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  movie Movie @relation(fields: [movieId], references: [id], onDelete: Cascade)

  @@unique([userId, movieId])
  @@map("watch_history")
}